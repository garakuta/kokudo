<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="ja">
<head>
  <title>国土数値情報　竜巻等の突風データ</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="js/select2/select2.css" type="text/css" />
  <link rel="stylesheet" href="js/jquery/jquery-ui.min.css" type="text/css" />
  <link rel="stylesheet" href="base.css" type="text/css" />
  <script type="text/javascript" src="js/async/lib/async.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" src="js/jquery/jquery-ui-1.10.4.min.js"></script>
  <script type="text/javascript" src="js/select2/select2.min.js"></script>
  <script type="text/javascript" src="js/blockui/jquery.blockUI.js"></script>
  <script type="text/javascript" src="js/d3/d3.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
  <script type="text/javascript" src="js/util.js"></script>
</head>
<body>
  <div id="contents">
    <p>この画面は「<a href="http://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-A30b.html">国土数値情報　竜巻等の突風データ</a>」を表示するものです。</p>
    <p>ドラッグで表示領域を変更し、データを取得します。</p>
    <div id="map_canvas" style="width: 800px; height: 600px"></div>
  </div>
<script type="text/javascript">
$(function() {
  $(document).ready(function() {
    var latlng = new google.maps.LatLng(35.709984,139.810703);
    var opts = {
      zoom: 13,
      center: latlng,
      //scrollwheel: false,
      disableDoubleClickZoom: true,
      scaleControl: false,
      //zoomControl : false,
      streetViewControl : false,
      mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("map_canvas"), opts);
    var markers = [];

    map.data.addListener('click', function(e) {
      //alert(areaType[e.feature.getProperty('hazardAreaType')].name + '\n' + e.feature.getProperty('remarks'));
      //console.log(areaType[e.feature.getProperty('hazardAreaType')].name, e.feature.getProperty('remarks'));
    });

    google.maps.event.addListener(map, 'dragend', function() {
      var statid = $("input[name='estatid']:checked").val();

      for (var i = 0; i < markers.length; ++i) {
        markers[i].setMap(null);
      }
      var latlngBounds = map.getBounds();
      var swLatlng = latlngBounds.getSouthWest();
      var swlat = swLatlng.lat();
      var swlng = swLatlng.lng();
      var neLatlng = latlngBounds.getNorthEast();
      var nelat = neLatlng.lat();
      var nelng = neLatlng.lng();

      var styleFeature = function() {
        return function(feature) {
          return {
            strokeWeight : 0.2,
            strokeColor : areaType[feature.getProperty('hazardAreaType')].color,
            fillColor: areaType[feature.getProperty('hazardAreaType')].color,
            fillOpacity: 0.5
          };
        };
      }

      function getGust(callback) {
        $.get(
          '/kokudo/json/get_gust_by_geometry',
          {
            swlat : swlat,
            swlng : swlng,
            nelat : nelat,
            nelng : nelng
          },
          function (res) {
            console.log('getGust', res);
            function createMarker(d) {
              var marker = new google.maps.Marker();
              marker.setPosition(
                new google.maps.LatLng(
                  d.geometry.coordinates[1], d.geometry.coordinates[0]
                )
              );
              marker.setMap(map);
              google.maps.event.addListener(marker, "click", function() {
                var c = '';
                c += 'prefectureName:' + d.prefectureName;
                c += '<BR>cityName:' + d.cityName;
                c += '<BR>address:' + d.address;
                c += '<BR>latErrorRage:' + d.latErrorRage;
                c += '<BR>longErrorRage:' + d.longErrorRage;
                c += '<BR>occurrenceDate:' + d.occurrenceDate;
                c += '<BR>dateErrorRange:' + d.dateErrorRange;
                c += '<BR>detailType:' + d.detailType;
                var infowindow = new google.maps.InfoWindow({
                  content: c
                });
                infowindow.open(map, marker);
              });
              markers.push(marker);
            }
            
            for (var key in res) {
              console.log(key, res[key]);
              var pathCoordinates = [];
              for (var i = 0; i < res[key].detail.length; ++i) {
                createMarker(res[key].detail[i]);
                pathCoordinates.push(
                  new google.maps.LatLng(res[key].detail[i].geometry.coordinates[1], res[key].detail[i].geometry.coordinates[0])
                );
                var path =new google.maps.Polyline({
                  path: pathCoordinates, 
                  strokeColor: '#008800',
                  strokeOpacity: 1.0, 
                  strokeWeight: 2, 
                  icons: [{
                    icon: {
                      path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                      fillOpacity:1
                    },
                    offset : '100%'
                  }]
                });
                path.setMap(map);
              }
            }
            
            callback(null, null);
          },
          'json'
        ).error(function(e){
           callback(e.responseText, null);
        });
      }

      $.blockUI({ message: '<img src="img/loading.gif" />' });
      async.parallel([
        getGust
      ], function(err, ret) {
        $.unblockUI();
        if (err) {
          return;
        }
      });
    });
    google.maps.event.addListener(map, 'bounds_changed', function() {
      console.log('bounds_changed');
    });
  });
});

</script>
</body>
</html>
